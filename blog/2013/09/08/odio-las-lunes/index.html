
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Odio las LUNes! - a t a s c o</title>
  <meta name="author" content="aH">

  
  <meta name="description" content="Odio Las LUNes! 08 Sep 2013 Julio y agosto, meses de vacaciones, momento ideal para romper la infraestructura virtual con las actualizaciones &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://atasco.github.io/blog/2013/09/08/odio-las-lunes">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="a t a s c o" type="application/atom+xml">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/js/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/octopress.js" type="text/javascript"></script>
  <script src="/js/jquery.cookieBar.js" type="text/javascript"></script>
  <link href="/stylesheets/cookieBar.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script type="text/javascript">
    $(document).ready(function() {
      $.cookieBar();
    });
  </script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46205791-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
        <li ><a href="/index.html">atasco</a></li>
    
        <li ><a href="/blog/archives/index.html">entradas</a></li>
    
</ul>

<ul class="nav pull-right">
    
    <li><a href="http://github.com/atasco" title="Github Profile"><i class="icon-github-sign social-navbar"></i></a></li>
    
    
    <li><a href="http://linkedin.com/in/jaalcaldehernando" title="Linkedin Profile"><i class="icon-linkedin-sign social-navbar"></i></a></li>
    
    
    <li><a href="http://twitter.com/by_atasco" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i></a></li>
    
    
    
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
    <div class="span12">
      <div class="row-fluid">
        <div id="content">
          <div>
<article class="hentry" role="article">
  

  <header>
  <div class="jumbotron">
    Odio Las LUNes!
	<h5>








  


<i class="icon-calendar-empty"></i> <time datetime="2013-09-08T20:30:00+02:00" pubdate data-updated="true">08 Sep 2013</time></h5>
  </div>
</header>
  <div class="row-fluid">
    <div class="span12">
      <p>Julio y agosto, meses de vacaciones, momento ideal para <em>romper</em> la infraestructura virtual con las actualizaciones anuales. Este año toca <strong>vSpehere 5.1</strong> (si esperamos un poco caemos en la 5.5).</p>

<p>Tras la pertinente revisión de compatibilidad de hardware y la toma de decisiones previas (que implican cambio del vCenter, nos pasamos al nuevo appliance bajo LiNUX <a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=2007619">VCSA</a>, asignación de nuevas LUN…) se procede a la instalación del nuevo vCenter y la migración de los ESX 4.1 U2.</p>

<!-- more -->


<p><strong>¡Sorpresa!</strong> Al disponer de diferente hardware no es posible actualizar a 5.1 parte de los blades HP BL460c (los G1) que forman parte de la infraestructura, por lo que se decide mantener un entorno mixto con servidores ESXi 5.0 y 5.1.</p>

<p>Esto supone reconsiderar la planificación inicial y separar los ESXi por versión en dos cluster (planificado inicialmente para mantener dos entornos independientes, uno para servidores de desarrollo y otro para los de producción) en vez de mantener un único cluster con un pool de recursos dedicado a las VM de desarrollo.</p>

<p>Una vez realizada la migración, se observa que el rendimiento en acceso a disco de las VM en los ESXi 5.0 no se corresponde con las VM en los ESXi 5.1.</p>

<p>Revisando la configuración se observa que la politica de selección de caminos en las LUNes de la cabina (EMC VNX 5500 que soporta el protocolo ALUA) para los ESXi 5.0 no es la que tenemos configurada habitualmente. Aparece como FIXED cuando debería estar como ROUND ROBIN.</p>

<p>Con el comando:</p>

<blockquote><p>esxcli storage nmp satp list</p></blockquote>

<p>Obtenemos la política de selección de caminos (PSP) actual.</p>

<p>Por ejemplo, en un ESXi 5.0:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>Name                 Default PSP    Description
</span><span class='line'>-------------------  -------------  -------------------------------------------------------
</span><span class='line'>VMW_SATP_ALUA_CX     VMW_PSP_FIXED  Supports EMC CX that use the ALUA protocol
</span><span class='line'>VMW_SATP_ALUA        VMW_PSP_MRU    Supports non-specific arrays that use the ALUA protocol
</span><span class='line'>VMW_SATP_CX          VMW_PSP_MRU    Supports EMC CX that <span class="k">do </span>not use the ALUA protocol
</span><span class='line'>VMW_SATP_MSA         VMW_PSP_MRU    Placeholder <span class="o">(</span>plugin not loaded<span class="o">)</span>
</span><span class='line'>VMW_SATP_DEFAULT_AP  VMW_PSP_MRU    Placeholder <span class="o">(</span>plugin not loaded<span class="o">)</span>
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Cambiar la PSP por defecto es sencillo, solo hay que ejecutar el comando:</p>

<blockquote><p>esxcli storage nmp satp set &mdash;default-psp=policy &mdash;satp=your_SATP_name</p></blockquote>

<p>Para cambiar el modo FIXED por ROUND ROBIN en la cabina VNX 3000 que soporta ALUA, el comando a ejecutar es:</p>

<blockquote><p>esxcli storage nmp satp set &mdash;default-psp=VMW_PSP_RR &mdash;satp=VMW_SATP_ALUA_CX</p></blockquote>

<p>A partir de ahora las nuevas LUN de la cabina que se presenten a los ESXi 5.0 tendrán como PSP Round Robin, pero las que se encuentran ya presentadas mantendrán la política Fixed.</p>

<p>Se puede cambiar la politica selección de camino reiniciando el ESXi para hacerlo de forma global para todas las LUN que se presebtan al mismo, o bien de forma individual para cada LUN.</p>

<p>Para conseguir que una LUN pase a utilizar un PSP diferente, ejecutamos el comando siguiente en el ESXi afectado:</p>

<blockquote><p>esxcli storage nmp device set -d NAAID -psp=policy</p></blockquote>

<p>Es necesario identificar previamente el NAAID de la LUN afectada. Para ello se puede hacer uso del cliente gráfico (viclient o web) o con el comando:</p>

<blockquote><p>esxcli storage nmp device list</p></blockquote>

<p>Una vez realizado el cambio se verifica el mismo con:</p>

<blockquote><p>esxcli storage nmp device list -d NAAID</p></blockquote>

<p>Ejemplo:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>esxcli storage nmp device <span class="nb">set</span> -d naa.6006016055711d00cff95e65664ee011 --psp<span class="o">=</span>VMW_PSP_MRU
</span></code></pre></td></tr></table></div></figure>


<p>Una vez realizados los cambios, con todos los ESXi utilizando la misma política de selección de caminos para las LUNes, el rendimiento de los hosts con versión 5.0 se estabiliza y adquiere valores similares a los que tienen la versión 5.1.</p>

<h2>Resumen</h2>

<h3>Cambio de la PSP por defecto</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Mirar la PSP (Path Selection Policy)actual</span>
</span><span class='line'>esxcli storage nmp satp list
</span><span class='line'><span class="c"># Cambiar la PSP por defecto</span>
</span><span class='line'>esxcli storage nmp satp <span class="nb">set</span> --default-psp<span class="o">=</span>policy --satp<span class="o">=</span>your_SATP_name
</span><span class='line'><span class="c"># Verificar el cambio</span>
</span><span class='line'>esxcli storage nmp satp list
</span></code></pre></td></tr></table></div></figure>


<h3>Cambio de la PSP por LUN</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Identificar LUN ID (NAA ID)</span>
</span><span class='line'><span class="c"># 1. En VI Client (o web).</span>
</span><span class='line'><span class="c"># 2. Vía comando</span>
</span><span class='line'>esxcli storage nmp device list
</span><span class='line'><span class="c"># Cambiar la PSP</span>
</span><span class='line'>esxcli storage nmp device <span class="nb">set</span> -d NAAID -psp<span class="o">=</span>policy
</span><span class='line'><span class="c"># Verificar el cambio</span>
</span><span class='line'>esxcli storage nmp device list -d NAAID
</span></code></pre></td></tr></table></div></figure>


<h2>Referencias</h2>

<p><a href="http://kb.vmware.com/selfservice/search.do?cmd=displayKC&amp;docType=kc&amp;docTypeID=DT_KB_1_1&amp;externalId=1017760">Changing the default pathing policy for new/existing LUNs</a></p>

<p><a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1036189">Changing a LUN to use a different Path Selection Policy</a></p>

    </div>
  </div>



  <footer>
    <hr>
    
    <div class="row-fluid">
      
      <div class="span6">
        <p class="meta">
        
        



  <a href="/blog/categories/vmware/"><span class="badge">vmware</span></a>




        </p>
      </div>
      
      <div class="span6 social-sharing">
        <div class="sharing">
  <div class="addthis_toolbox addthis_default_style ">
  
  
  <a class="addthis_button_tweet"></a>
  
  
  <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>

      </div>
      
      
    </div>
    
    <div class="row-fluid">
      <div class="span12">
        <p class="meta">
          
            <a class="basic-alignment left" href="/blog/2013/07/14/como-se-hizo/" title="Previous Post: Cómo se hizo">&laquo; Cómo se hizo</a>
          
          
            <a class="basic-alignment right" href="/blog/2013/11/28/parcheando-esxi-sin-vum/" title="Next Post: Parcheando ESXi 5.X sin VUM">Parcheando ESXi 5.X sin VUM &raquo;</a>
          
        </p>
      </div>
    </div>
  </footer>
</article>

  <section>
    <h1>Comentarios</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>



        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p align="center">
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.es_ES"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a> - 2014 - aH - <a href="/politica-de-cookies">Política de Cookies</a>
</br>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> and <a href="http://alexgaribay.com">Octoflat</a>
</p>


        </footer>
      </div>
    </div>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'atasco';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://atasco.github.io/blog/2013/09/08/odio-las-lunes/';
        var disqus_url = 'http://atasco.github.io/blog/2013/09/08/odio-las-lunes/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
